---
title: Database Schema
description: Understanding the Locallytics database structure
---

# Database Schema

Locallytics uses a simple, efficient database schema to store analytics events.

## Table: `loc_events`

The main table that stores all analytics events (pageviews and custom events).

### Columns

| Column       | Type    | Nullable | Description                                    |
| ------------ | ------- | -------- | ---------------------------------------------- |
| `id`         | TEXT    | No       | Primary key (UUID)                             |
| `ts`         | BIGINT  | No       | Timestamp (epoch milliseconds)                 |
| `session_id` | TEXT    | No       | Session identifier                             |
| `anon_id`    | TEXT    | Yes      | Anonymous user ID (from localStorage)          |
| `type`       | TEXT    | No       | Event type: 'pageview' or 'event'              |
| `name`       | TEXT    | Yes      | Custom event name (for type='event')           |
| `url`        | TEXT    | No       | Full URL                                       |
| `path`       | TEXT    | No       | URL path                                       |
| `referrer`   | TEXT    | Yes      | HTTP referrer                                  |
| `title`      | TEXT    | Yes      | Page title (for pageviews)                     |
| `props`      | TEXT    | Yes      | JSON string of event properties                |
| `screen_w`   | INTEGER | Yes      | Screen width in pixels                         |
| `screen_h`   | INTEGER | Yes      | Screen height in pixels                        |
| `ip_hash`    | TEXT    | Yes      | IP address hash (optional, not currently used) |

### Indexes

Locallytics creates three indexes for efficient querying:

#### `loc_by_ts`

```sql
CREATE INDEX loc_by_ts ON loc_events(ts);
```

Used for time-based queries and date range filtering.

#### `loc_by_path_ts`

```sql
CREATE INDEX loc_by_path_ts ON loc_events(path, ts);
```

Used for path-specific analytics queries (e.g., getting stats for `/blog` pages).

#### `loc_by_type_ts`

```sql
CREATE INDEX loc_by_type_ts ON loc_events(type, ts);
```

Used for filtering by event type (pageview vs custom events).

## Schema Files

Locallytics includes ready-to-use schema files in the package:

- `node_modules/locallytics/schemas/postgres.sql` - PostgreSQL schema
- `node_modules/locallytics/schemas/sqlite.sql` - SQLite schema

## PostgreSQL Schema

```sql
CREATE TABLE IF NOT EXISTS loc_events (
  id TEXT PRIMARY KEY,
  ts BIGINT NOT NULL,
  session_id TEXT NOT NULL,
  anon_id TEXT,
  type TEXT NOT NULL,
  name TEXT,
  url TEXT NOT NULL,
  path TEXT NOT NULL,
  referrer TEXT,
  title TEXT,
  props TEXT,
  screen_w INTEGER,
  screen_h INTEGER,
  ip_hash TEXT
);

CREATE INDEX IF NOT EXISTS loc_by_ts ON loc_events(ts);
CREATE INDEX IF NOT EXISTS loc_by_path_ts ON loc_events(path, ts);
CREATE INDEX IF NOT EXISTS loc_by_type_ts ON loc_events(type, ts);
```

## SQLite Schema

Similar to PostgreSQL, with SQLite-specific syntax.

## Event Types

### Pageview Events

Automatically tracked when a page loads.

**Example row:**

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "ts": 1704067200000,
  "session_id": "abc123",
  "anon_id": "user123",
  "type": "pageview",
  "name": null,
  "url": "https://example.com/blog/post-1",
  "path": "/blog/post-1",
  "referrer": "https://google.com",
  "title": "My Blog Post",
  "props": null,
  "screen_w": 1920,
  "screen_h": 1080,
  "ip_hash": null
}
```

### Custom Events

Tracked using `window.locallytics.track()`.

**Example row:**

```json
{
  "id": "660e8400-e29b-41d4-a716-446655440001",
  "ts": 1704067200000,
  "session_id": "abc123",
  "anon_id": "user123",
  "type": "event",
  "name": "button_click",
  "url": "https://example.com/pricing",
  "path": "/pricing",
  "referrer": null,
  "title": null,
  "props": "{\"button\":\"signup\",\"location\":\"header\"}",
  "screen_w": 1920,
  "screen_h": 1080,
  "ip_hash": null
}
```

## Query Examples

### Get total pageviews

```sql
SELECT COUNT(*) FROM loc_events
WHERE type = 'pageview';
```

### Get unique visitors

```sql
SELECT COUNT(DISTINCT anon_id) FROM loc_events
WHERE type = 'pageview';
```

### Get top pages

```sql
SELECT path, COUNT(*) as pageviews
FROM loc_events
WHERE type = 'pageview'
GROUP BY path
ORDER BY pageviews DESC
LIMIT 10;
```

### Get events in date range

```sql
SELECT * FROM loc_events
WHERE ts >= 1704067200000
  AND ts <= 1706745600000;
```

### Get custom events by name

```sql
SELECT * FROM loc_events
WHERE type = 'event'
  AND name = 'button_click';
```

## Using Kysely for Custom Queries

You can access the Kysely instance directly for custom queries:

```typescript
import { locallytics } from 'locallytics';

const analytics = await locallytics({
  database: process.env.DATABASE_URL!,
});

// Custom query
const topEvents = await analytics.db
  .selectFrom('loc_events')
  .select(['name', analytics.db.fn.count('id').as('count')])
  .where('type', '=', 'event')
  .where('ts', '>=', Date.now() - 24 * 60 * 60 * 1000)
  .groupBy('name')
  .orderBy('count', 'desc')
  .limit(10)
  .execute();
```

## Data Retention

Locallytics doesn't automatically delete old data. You can implement your own data retention policy:

```sql
-- Delete events older than 90 days
DELETE FROM loc_events
WHERE ts < EXTRACT(EPOCH FROM NOW() - INTERVAL '90 days') * 1000;
```

Or use a cron job with Kysely:

```typescript
// Delete events older than 90 days
await analytics.db
  .deleteFrom('loc_events')
  .where('ts', '<', Date.now() - 90 * 24 * 60 * 60 * 1000)
  .execute();
```

## Performance Considerations

- The three indexes (`loc_by_ts`, `loc_by_path_ts`, `loc_by_type_ts`) ensure fast queries
- For large datasets (millions of events), consider partitioning by date
- Use connection pooling for optimal performance (handled automatically by Kysely)
- Consider archiving old data to a separate table or storage

## Privacy & GDPR

To delete all data for a specific user:

```sql
DELETE FROM loc_events WHERE anon_id = 'user123';
```

Or with Kysely:

```typescript
await analytics.db.deleteFrom('loc_events').where('anon_id', '=', 'user123').execute();
```

## Next Steps

<Cards>
  <Card
    title="API Reference"
    href="/docs/api-reference"
    description="Explore all available APIs"
  />
  <Card
    title="Advanced Usage"
    href="/docs/advanced-usage"
    description="Learn about custom queries and filtering"
  />
</Cards>
